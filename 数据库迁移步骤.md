# 数据库迁移步骤 - 星盘功能

## 问题
如果看到错误："Could not find the table 'public.user_profiles'"，说明需要先创建数据库表。

## 解决步骤

### 方法一：通过 Supabase Dashboard（推荐）

1. **打开 Supabase Dashboard**
   - 访问 https://supabase.com/dashboard
   - 登录并选择你的项目

2. **进入 SQL Editor**
   - 在左侧菜单中点击 "SQL Editor"
   - 点击 "New query" 按钮

3. **执行 SQL 迁移**
   - 打开项目中的 `supabase_migration_astrology.sql` 文件
   - 复制文件中的所有 SQL 代码
   - 粘贴到 SQL Editor 中
   - 点击 "Run" 按钮（或按 Cmd/Ctrl + Enter）

4. **验证创建成功**
   - 在左侧菜单中点击 "Table Editor"
   - 应该能看到 `user_profiles` 表

### 方法二：直接复制以下 SQL

如果找不到文件，可以直接复制以下 SQL 代码到 Supabase SQL Editor 执行：

```sql
-- 创建用户资料表（用于存储生日和地理位置）
CREATE TABLE IF NOT EXISTS user_profiles (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID NOT NULL UNIQUE REFERENCES auth.users(id) ON DELETE CASCADE,
  birthday TIMESTAMPTZ,
  latitude DECIMAL(10, 6),
  longitude DECIMAL(10, 6),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_user_profiles_user_id ON user_profiles(user_id);

-- 启用 Row Level Security (RLS)
ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;

-- 创建策略：用户只能访问自己的资料
CREATE POLICY "Users can view their own profile"
  ON user_profiles FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own profile"
  ON user_profiles FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own profile"
  ON user_profiles FOR UPDATE
  USING (auth.uid() = user_id);

CREATE POLICY "Users can delete their own profile"
  ON user_profiles FOR DELETE
  USING (auth.uid() = user_id);

-- 创建触发器：自动更新 updated_at
-- 注意：如果 update_updated_at_column() 函数不存在，需要先创建它
-- 通常这个函数在创建 life_events 表时已经创建了
-- 如果没有，执行以下代码：
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_user_profiles_updated_at
  BEFORE UPDATE ON user_profiles
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

## 执行后

执行成功后：
1. 刷新你的应用页面
2. 再次尝试设置出生信息
3. 应该就能正常保存了

## 如果还有问题

- 检查 Supabase 项目是否正确配置
- 确认环境变量 `VITE_SUPABASE_URL` 和 `VITE_SUPABASE_ANON_KEY` 是否正确
- 查看浏览器控制台是否有其他错误信息
